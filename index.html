<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bloxd.io Image Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        canvas { image-rendering: pixelated; max-width: 100%; height: auto; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
        // --- 1. ÂÆöÊï∞ ---
        const PALETTE = [
            { id: 51, rgb: [233, 236, 236], name: 'White Wool' },
            { id: 52, rgb: [240, 118, 19], name: 'Orange Wool' },
            { id: 53, rgb: [189, 68, 179], name: 'Magenta Wool' },
            { id: 54, rgb: [58, 175, 217], name: 'Light Blue Wool' },
            { id: 55, rgb: [248, 197, 39], name: 'Yellow Wool' },
            { id: 56, rgb: [112, 185, 25], name: 'Lime Wool' },
            { id: 57, rgb: [237, 141, 172], name: 'Pink Wool' },
            { id: 58, rgb: [62, 68, 71], name: 'Gray Wool' },
            { id: 59, rgb: [142, 142, 134], name: 'Light Gray Wool' },
            { id: 60, rgb: [21, 137, 145], name: 'Cyan Wool' },
            { id: 61, rgb: [121, 42, 172], name: 'Purple Wool' },
            { id: 62, rgb: [53, 57, 157], name: 'Blue Wool' },
            { id: 63, rgb: [114, 71, 40], name: 'Brown Wool' },
            { id: 64, rgb: [84, 109, 27], name: 'Green Wool' },
            { id: 65, rgb: [160, 39, 34], name: 'Red Wool' },
            { id: 66, rgb: [20, 21, 25], name: 'Black Wool' },
            { id: 97, rgb: [207, 213, 214], name: 'White Concrete' },
            { id: 93, rgb: [224, 97, 0], name: 'Orange Concrete' },
            { id: 92, rgb: [169, 48, 159], name: 'Magenta Concrete' },
            { id: 90, rgb: [35, 137, 198], name: 'Light Blue Concrete' },
            { id: 99, rgb: [240, 175, 21], name: 'Yellow Concrete' },
            { id: 91, rgb: [94, 169, 24], name: 'Lime Concrete' },
            { id: 94, rgb: [213, 101, 142], name: 'Pink Concrete' },
            { id: 84, rgb: [54, 57, 61], name: 'Gray Concrete' },
            { id: 85, rgb: [125, 125, 115], name: 'Light Gray Concrete' },
            { id: 89, rgb: [21, 119, 136], name: 'Cyan Concrete' },
            { id: 95, rgb: [100, 31, 156], name: 'Purple Concrete' },
            { id: 87, rgb: [44, 46, 143], name: 'Blue Concrete' },
            { id: 88, rgb: [96, 59, 31], name: 'Brown Concrete' },
            { id: 98, rgb: [73, 91, 36], name: 'Green Concrete' },
            { id: 96, rgb: [142, 32, 32], name: 'Red Concrete' },
            { id: 86, rgb: [8, 10, 15], name: 'Black Concrete' }
        ];
        const CHUNK_SIZE = 32;

        // --- 2. ÁøªË®≥„Éá„Éº„Çø ---
        const i18n = {
            ja: {
                title: "Bloxd.ioÁîªÂÉè„Ç≥„É≥„Éê„Éº„Çø„Éº",
                creator: "‰ΩúÊàêËÄÖ",
                langBtn: "English",
                howToBtn: "‰Ωø„ÅÑÊñπ",
                labelFile: "1. ÁîªÂÉè„ÇíÈÅ∏Êäû",
                labelHeight: "2. È´ò„Åï(„Éñ„É≠„ÉÉ„ÇØ)",
                labelAxis: "3. Âêë„Åç",
                axisZ: "Â£Å (Ê≠£Èù¢)",
                axisX: "Â∫ä (Âπ≥Èù¢)",
                statusWait: "ÁîªÂÉè„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
                statusLoaded: "ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ",
                statusConverting: "Â§âÊèõ‰∏≠...",
                statusDone: "ÂÆå‰∫ÜÔºÅBloxd.io„Åß„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                btnConvert: "Â§âÊèõ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                btnProcessing: "Âá¶ÁêÜ‰∏≠...",
                preview: "„Éó„É¨„Éì„É•„Éº",
                howToTitle: "‰Ωø„ÅÑÊñπ„ÅÆË™¨Êòé",
                howToStep1: "1. ÁîªÂÉè„ÇíÈÅ∏Êäû„Éú„Çø„É≥„Åã„ÇâÂ§âÊèõ„Åó„Åü„ÅÑÁîªÂÉè„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇ",
                howToStep2: "2. È´ò„Åï„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇÊ®™ÂπÖ„ÅØËá™Âãï„ÅßË™øÊï¥„Åï„Çå„Åæ„Åô„ÄÇ",
                howToStep3: "3. Âêë„Åç„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇÂ£Å„Å´Ë≤º„Çã„Å™„Çâ„ÄéÂ£Å„Äè„ÄÅÂú∞Èù¢„Å´ÁΩÆ„Åè„Å™„Çâ„ÄéÂ∫ä„Äè„Åß„Åô„ÄÇ",
                howToStep4: "4. Â§âÊèõ„Éú„Çø„É≥„ÇíÊäº„Åô„Å® .bloxdschem „Éï„Ç°„Ç§„É´„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ",
                howToStep5: "5. Bloxd.ioÂÜÖ„Åß /import „Ç≥„Éû„É≥„Éâ„Çí‰Ωø„Å£„Å¶Ë™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
                close: "Èñâ„Åò„Çã"
            },
            en: {
                title: "Bloxd.io Image Converter",
                creator: "Creator",
                langBtn: "Êó•Êú¨Ë™û",
                howToBtn: "How to use",
                labelFile: "1. Select Image",
                labelHeight: "2. Height (Blocks)",
                labelAxis: "3. Orientation",
                axisZ: "Wall (Z)",
                axisX: "Floor (X)",
                statusWait: "Please select an image.",
                statusLoaded: "Image loaded.",
                statusConverting: "Converting...",
                statusDone: "Done! Import this in Bloxd.io.",
                btnConvert: "Convert & Download",
                btnProcessing: "Processing...",
                preview: "Preview",
                howToTitle: "How to use",
                howToStep1: "1. Click 'Select Image' to choose your file.",
                howToStep2: "2. Enter the height. Width will be adjusted automatically.",
                howToStep3: "3. Choose orientation. 'Wall' for vertical, 'Floor' for horizontal.",
                howToStep4: "4. Click 'Convert' to download the .bloxdschem file.",
                howToStep5: "5. Use /import command inside Bloxd.io to load it.",
                close: "Close"
            }
        };

        // --- 3. „É≠„Ç∏„ÉÉ„ÇØ ---
        class BloxdWriter {
            constructor() { this.buf = []; }
            varint(v) { while (v & -128) { this.buf.push((v & 0x7f) | 0x80); v >>>= 7; } this.buf.push(v); }
            zigzag(n) { this.varint((n << 1) ^ (n >> 31)); }
            str(s) { const b = new TextEncoder().encode(s); this.zigzag(b.length); b.forEach(v => this.buf.push(v)); }
            bytes(b) { this.zigzag(b.length); for (const v of b) { this.buf.push(v); } }
            u8(v) { this.buf.push(v & 255); }
            getBlob() { return new Blob([new Uint8Array(this.buf)], { type: "application/octet-stream" }); }
        }

        function compressRLE(arr) {
            const out = [];
            if (arr.length === 0) return new Uint8Array(out);
            let last = arr[0], cnt = 1;
            const pushRun = (count, id) => {
                let c = count; while (c & -128) { out.push((c & 0x7f) | 0x80); c >>>= 7; } out.push(c);
                let v = id; while (v & -128) { out.push((v & 0x7f) | 0x80); v >>>= 7; } out.push(v);
            };
            for (let i = 1; i <= arr.length; i++) {
                const v = i < arr.length ? arr[i] : -1;
                if (v === last) { cnt++; } else { pushRun(cnt, last); last = v; cnt = 1; }
            }
            return new Uint8Array(out);
        }

        const Axis = { Z: "Z", X: "X" };
        function nearestColorID(r, g, b, a) {
            if (a < 128) return 0;
            let best = 0, min = 1e9;
            for (const p of PALETTE) {
                const d = (r - p.rgb[0]) ** 2 + (g - p.rgb[1]) ** 2 + (b - p.rgb[2]) ** 2;
                if (d < min) { min = d; best = p.id; }
            }
            return best;
        }

        const generateSchematic = (imgData, imgWidth, imgHeight, axis) => {
            const sizeY = imgHeight;
            const depth = 2;
            let sizeX = axis === Axis.Z ? imgWidth : depth;
            let sizeZ = axis === Axis.Z ? depth : imgWidth;
            const blocks = Array.from({ length: sizeY }, () => Array.from({ length: sizeZ }, () => new Array(sizeX).fill(0)));
            for (let y = 0; y < imgHeight; y++) {
                for (let x = 0; x < imgWidth; x++) {
                    const i = (y * imgWidth + x) * 4;
                    const id = nearestColorID(imgData[i], imgData[i + 1], imgData[i + 2], imgData[i + 3]);
                    if (!id) continue;
                    const by = sizeY - 1 - y;
                    if (axis === Axis.Z) { blocks[by][0][x] = id; blocks[by][1][x] = id; }
                    else { blocks[by][x][0] = id; blocks[by][x][1] = id; }
                }
            }
            const w = new BloxdWriter();
            w.u8(4); w.u8(0); w.u8(0); w.u8(0);
            w.str("FromImage");
            w.zigzag(0); w.zigzag(0); w.zigzag(0);
            w.zigzag(sizeX); w.zigzag(sizeY); w.zigzag(sizeZ);
            const CX = Math.ceil(sizeX / CHUNK_SIZE), CY = Math.ceil(sizeY / CHUNK_SIZE), CZ = Math.ceil(sizeZ / CHUNK_SIZE);
            w.zigzag(CX * CY * CZ);
            for (let cx = 0; cx < CX; cx++) {
                for (let cy = 0; cy < CY; cy++) {
                    for (let cz = 0; cz < CZ; cz++) {
                        w.zigzag(cx); w.zigzag(cy); w.zigzag(cz);
                        const raw = [];
                        for (let lx = 0; lx < CHUNK_SIZE; lx++) {
                            for (let ly = 0; ly < CHUNK_SIZE; ly++) {
                                for (let lz = 0; lz < CHUNK_SIZE; lz++) {
                                    const gx = cx * CHUNK_SIZE + lx, gy = cy * CHUNK_SIZE + ly, gz = cz * CHUNK_SIZE + lz;
                                    raw.push((gx < sizeX && gy < sizeY && gz < sizeZ) ? blocks[gy][gz][gx] : 0);
                                }
                            }
                        }
                        w.bytes(compressRLE(raw));
                    }
                }
            }
            w.zigzag(0); w.zigzag(0); w.zigzag(0); w.zigzag(0); w.zigzag(0); w.u8(0); w.u8(0);
            return w.getBlob();
        };

        // --- 4. „É°„Ç§„É≥UI ---
        const { useState, useRef, useEffect } = React;

        function App() {
            const [lang, setLang] = useState('ja');
            const [showHowTo, setShowHowTo] = useState(false);
            const t = i18n[lang];

            const [imgFile, setImgFile] = useState(null);
            const [imgSrc, setImgSrc] = useState(null);
            const [height, setHeight] = useState(32);
            const [axis, setAxis] = useState(Axis.Z);
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState(t.statusWait);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!imgFile) setStatus(t.statusWait);
                else if (!isProcessing) setStatus(t.statusLoaded);
            }, [lang]);

            const handleFileChange = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    setImgFile(file);
                    setImgSrc(URL.createObjectURL(file));
                    setStatus(t.statusLoaded);
                }
            };

            const toggleLang = () => setLang(lang === 'ja' ? 'en' : 'ja');

            useEffect(() => {
                if (!imgSrc || !canvasRef.current) return;
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    const aspect = img.width / img.height;
                    const targetWidth = Math.round(height * aspect);
                    canvas.width = targetWidth; canvas.height = height;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 0, 0, targetWidth, height);
                };
            }, [imgSrc, height]);

            const handleConvert = async () => {
                if (!imgSrc || !canvasRef.current) return;
                setIsProcessing(true); setStatus(t.statusConverting);
                try {
                    await new Promise(r => setTimeout(r, 100));
                    const canvas = canvasRef.current;
                    const imgData = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
                    const blob = generateSchematic(imgData.data, canvas.width, canvas.height, axis);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `image_${canvas.width}x${height}.bloxdschem`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    setStatus(t.statusDone);
                } catch (e) { setStatus(`Error: ${e.message}`); }
                finally { setIsProcessing(false); }
            };

            return (
                <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4 text-white relative">
                    {/* Â∑¶‰∏ä: ‰Ωø„ÅÑÊñπ„Éú„Çø„É≥ */}
                    <button 
                        onClick={() => setShowHowTo(true)}
                        className="absolute top-6 left-6 bg-gray-700 hover:bg-gray-600 w-10 h-10 rounded-full flex items-center justify-center font-bold border border-gray-500 transition-transform active:scale-90"
                        title={t.howToBtn}
                    >
                        Ôºü
                    </button>

                    {/* Âè≥‰∏ä: Ë®ÄË™ûÂàá„ÇäÊõø„Åà */}
                    <button 
                        onClick={toggleLang}
                        className="absolute top-6 right-6 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-full text-sm font-bold border border-gray-500"
                    >
                        {t.langBtn}
                    </button>

                    {/* ‰Ωø„ÅÑÊñπ„É¢„Éº„ÉÄ„É´ */}
                    {showHowTo && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={() => setShowHowTo(false)}>
                            <div className="bg-gray-800 p-6 rounded-2xl max-w-md w-full border border-gray-600 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-bold text-green-400 mb-4 flex items-center">
                                    <span className="mr-2">üí°</span> {t.howToTitle}
                                </h2>
                                <ul className="space-y-3 text-sm text-gray-200">
                                    <li>{t.howToStep1}</li>
                                    <li>{t.howToStep2}</li>
                                    <li>{t.howToStep3}</li>
                                    <li>{t.howToStep4}</li>
                                    <li>{t.howToStep5}</li>
                                </ul>
                                <button 
                                    onClick={() => setShowHowTo(false)}
                                    className="mt-6 w-full py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold"
                                >
                                    {t.close}
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-2xl w-full border border-gray-700">
                        <h1 className="text-3xl font-bold text-green-500 mb-1 text-center">{t.title}</h1>
                        
                        <div className="mb-6 text-center text-xs text-gray-400">
                            <p>{t.creator}: <span className="text-green-400 font-bold">AIXAI_YT</span></p>
                            <p>YouTube: <a href="https://www.youtube.com/@AIXAI-r7w" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">https://www.youtube.com/@AIXAI-r7w</a></p>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className="block text-gray-400 text-sm mb-2 font-bold">{t.labelFile}</label>
                                <input type="file" accept="image/*" onChange={handleFileChange} className="w-full bg-gray-700 p-2 rounded cursor-pointer border border-gray-600" />
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="block text-gray-400 text-sm mb-2 font-bold">{t.labelHeight}</label>
                                    <input type="number" value={height} onChange={(e) => setHeight(parseInt(e.target.value) || 1)} className="w-full bg-gray-700 p-2 rounded border border-gray-600 outline-none focus:border-green-500" />
                                </div>
                                <div className="flex-1">
                                    <label className="block text-gray-400 text-sm mb-2 font-bold">{t.labelAxis}</label>
                                    <select value={axis} onChange={(e) => setAxis(e.target.value)} className="w-full bg-gray-700 p-2 rounded border border-gray-600 cursor-pointer">
                                        <option value={Axis.Z}>{t.axisZ}</option>
                                        <option value={Axis.X}>{t.axisX}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="bg-gray-900 p-3 rounded text-yellow-300 text-center font-mono text-sm border border-gray-700">
                                {status}
                            </div>

                            <button onClick={handleConvert} disabled={!imgFile || isProcessing} className="w-full py-4 bg-green-600 rounded-lg font-bold text-lg hover:bg-green-500 disabled:bg-gray-600 transition-all active:scale-95 shadow-lg">
                                {isProcessing ? t.btnProcessing : t.btnConvert}
                            </button>
                            
                            <div className="text-center text-xs text-gray-500 mb-[-1rem]">{t.preview}</div>
                            <div className="flex justify-center bg-black/40 p-4 rounded-lg border border-gray-700 overflow-auto shadow-inner min-h-[100px] items-center text-gray-600 italic">
                                {imgSrc ? <canvas ref={canvasRef} /> : 'No image'}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
