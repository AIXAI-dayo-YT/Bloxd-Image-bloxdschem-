<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bloxd.io Image Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        .font-cyber { font-family: 'Orbitron', 'Noto Sans JP', sans-serif; }
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
        canvas { image-rendering: pixelated; max-width: 100%; height: auto; border-radius: 4px; }
        .transition-theme { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .light .glass { background: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.1); }
        .glow-green { box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); }
    </style>
</head>
<body class="font-sans antialiased transition-theme overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
        const { useState, useRef, useEffect } = React;

        // --- 1. ÂÆöÊï∞ („Éë„É¨„ÉÉ„Éà„Å´ Chalk „ÇíËøΩÂä†) ---
        const PALETTE = [
            // Wool
            { id: 51, rgb: [233, 236, 236], name: 'White Wool' },
            { id: 52, rgb: [240, 118, 19], name: 'Orange Wool' },
            { id: 53, rgb: [189, 68, 179], name: 'Magenta Wool' },
            { id: 54, rgb: [58, 175, 217], name: 'Light Blue Wool' },
            { id: 55, rgb: [248, 197, 39], name: 'Yellow Wool' },
            { id: 56, rgb: [112, 185, 25], name: 'Lime Wool' },
            { id: 57, rgb: [237, 141, 172], name: 'Pink Wool' },
            { id: 58, rgb: [62, 68, 71], name: 'Gray Wool' },
            { id: 59, rgb: [142, 142, 134], name: 'Light Gray Wool' },
            { id: 60, rgb: [21, 137, 145], name: 'Cyan Wool' },
            { id: 61, rgb: [121, 42, 172], name: 'Purple Wool' },
            { id: 62, rgb: [53, 57, 157], name: 'Blue Wool' },
            { id: 63, rgb: [114, 71, 40], name: 'Brown Wool' },
            { id: 64, rgb: [84, 109, 27], name: 'Green Wool' },
            { id: 65, rgb: [160, 39, 34], name: 'Red Wool' },
            { id: 66, rgb: [20, 21, 25], name: 'Black Wool' },
            // Concrete
            { id: 97, rgb: [207, 213, 214], name: 'White Concrete' },
            { id: 93, rgb: [224, 97, 0], name: 'Orange Concrete' },
            { id: 92, rgb: [169, 48, 159], name: 'Magenta Concrete' },
            { id: 90, rgb: [35, 137, 198], name: 'Light Blue Concrete' },
            { id: 99, rgb: [240, 175, 21], name: 'Yellow Concrete' },
            { id: 91, rgb: [94, 169, 24], name: 'Lime Concrete' },
            { id: 94, rgb: [213, 101, 142], name: 'Pink Concrete' },
            { id: 84, rgb: [54, 57, 61], name: 'Gray Concrete' },
            { id: 85, rgb: [125, 125, 115], name: 'Light Gray Concrete' },
            { id: 89, rgb: [21, 119, 136], name: 'Cyan Concrete' },
            { id: 95, rgb: [100, 31, 156], name: 'Purple Concrete' },
            { id: 87, rgb: [44, 46, 143], name: 'Blue Concrete' },
            { id: 88, rgb: [96, 59, 31], name: 'Brown Concrete' },
            { id: 98, rgb: [73, 91, 36], name: 'Green Concrete' },
            { id: 96, rgb: [142, 32, 32], name: 'Red Concrete' },
            { id: 86, rgb: [8, 10, 15], name: 'Black Concrete' },
            // Chalk (New!)
            { id: 188, rgb: [240, 240, 240], name: 'White Chalk' },
            { id: 192, rgb: [245, 160, 90],  name: 'Orange Chalk' },
            { id: 193, rgb: [215, 120, 215], name: 'Magenta Chalk' },
            { id: 196, rgb: [140, 200, 230], name: 'Light Blue Chalk' },
            { id: 187, rgb: [245, 225, 90],  name: 'Yellow Chalk' },
            { id: 194, rgb: [170, 220, 90],  name: 'Lime Chalk' },
            { id: 191, rgb: [245, 170, 200], name: 'Pink Chalk' },
            { id: 198, rgb: [140, 140, 140], name: 'Gray Chalk' },
            { id: 195, rgb: [200, 200, 200], name: 'Light Gray Chalk' },
            { id: 199, rgb: [90, 200, 200],  name: 'Cyan Chalk' },
            { id: 190, rgb: [170, 120, 210], name: 'Purple Chalk' },
            { id: 201, rgb: [90, 120, 220],  name: 'Blue Chalk' },
            { id: 200, rgb: [150, 110, 70],  name: 'Brown Chalk' },
            { id: 197, rgb: [120, 190, 120], name: 'Green Chalk' },
            { id: 189, rgb: [210, 90, 90],   name: 'Red Chalk' },
            { id: 202, rgb: [30, 30, 30],    name: 'Black Chalk' }
        ];

        // --- 2. ÁøªË®≥„Éá„Éº„Çø ---
        const i18n = {
            ja: {
                title: "Bloxd.io Image Converter",
                creator: "‰ΩúÊàêËÄÖ",
                langBtn: "English",
                labelFile: "1. ÁîªÂÉè„ÇíÈÅ∏Êäû",
                labelHeight: "2. È´ò„Åï(„Éñ„É≠„ÉÉ„ÇØ)",
                labelAxis: "3. Âêë„Åç",
                axisZ: "Âêë„Åç Z (Â£Å)",
                axisX: "Âêë„Åç X (Â∫ä)",
                statusWait: "ÁîªÂÉè„ÇíË™≠„ÅøËæº„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ",
                statusLoaded: "ÁîªÂÉè„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü„ÄÇ",
                statusConverting: "Â§âÊèõÂá¶ÁêÜ‰∏≠...",
                statusDone: "Â§âÊèõÂÆå‰∫ÜÔºÅ",
                btnConvert: "Â§âÊèõ„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                btnProcessing: "Âá¶ÁêÜ‰∏≠...",
                previewTitle: "„Éó„É¨„Éì„É•„Éº",
                prevOriginal: "ÂÖÉ„ÅÆÁîªÂÉè",
                prevBloxd: "BloxdÈ¢®",
                howToTitle: "‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ",
                howToStep1: "1. ÁîªÂÉè„ÇíÈÅ∏Êäû„Éú„Çø„É≥„Åã„Çâ„Éï„Ç°„Ç§„É´„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇ",
                howToStep2: "2. È´ò„Åï„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇÊ®™ÂπÖ„ÅØËá™Âãï„ÅßË™øÊï¥„Åï„Çå„Åæ„Åô„ÄÇ",
                howToStep3: "3. Âêë„ÅçÔºàZËª∏„Åæ„Åü„ÅØXËª∏Ôºâ„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇ",
                howToStep4: "4. Â§âÊèõ„Éú„Çø„É≥„ÇíÊäº„Åô„Å® .bloxdschem „Éï„Ç°„Ç§„É´„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ",
                howToStep5: "5. Bloxd.ioÂÜÖ„Åß //schematic load „Çí‰Ωø„ÅÑ„ÄÅË™≠„ÅøËæº„ÅøÂæå„Å´ //paste „ÅßË®≠ÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                close: "Èñâ„Åò„Çã"
            },
            en: {
                title: "Bloxd.io Image Converter",
                creator: "Creator",
                langBtn: "Êó•Êú¨Ë™û",
                labelFile: "1. Select Image",
                labelHeight: "2. Height (Blocks)",
                labelAxis: "3. Orientation",
                axisZ: "Axis Z (Wall)",
                axisX: "Axis X (Floor)",
                statusWait: "Please select an image.",
                statusLoaded: "Image loaded successfully.",
                statusConverting: "Converting now...",
                statusDone: "Done!",
                btnConvert: "Convert & Download",
                btnProcessing: "Processing...",
                previewTitle: "Preview",
                prevOriginal: "Original",
                prevBloxd: "Bloxd Style",
                howToTitle: "How to use",
                howToStep1: "1. Click 'Select Image' to pick a file.",
                howToStep2: "2. Set the height. Width is auto-calculated.",
                howToStep3: "3. Choose orientation (Axis Z or X).",
                howToStep4: "4. Click 'Convert' to download the .bloxdschem file.",
                howToStep5: "5. Use //schematic load in Bloxd.io, then //paste to place it.",
                close: "Close"
            }
        };

        // --- 3. „É≠„Ç∏„ÉÉ„ÇØÈÉ® (BloxdWriter) ---
        class BloxdWriter {
            constructor() { this.buf = []; }
            varint(v) { while (v & -128) { this.buf.push((v & 0x7f) | 0x80); v >>>= 7; } this.buf.push(v); }
            zigzag(n) { this.varint((n << 1) ^ (n >> 31)); }
            str(s) { const b = new TextEncoder().encode(s); this.zigzag(b.length); b.forEach(v => this.buf.push(v)); }
            bytes(b) { this.zigzag(b.length); for (const v of b) { this.buf.push(v); } }
            u8(v) { this.buf.push(v & 255); }
            getBlob() { return new Blob([new Uint8Array(this.buf)], { type: "application/octet-stream" }); }
        }

        function compressRLE(arr) {
            const out = []; if (arr.length === 0) return new Uint8Array(out);
            let last = arr[0], cnt = 1;
            const pushRun = (count, id) => {
                let c = count; while (c & -128) { out.push((c & 0x7f) | 0x80); c >>>= 7; } out.push(c);
                let v = id; while (v & -128) { out.push((v & 0x7f) | 0x80); v >>>= 7; } out.push(v);
            };
            for (let i = 1; i <= arr.length; i++) {
                const v = i < arr.length ? arr[i] : -1;
                if (v === last) cnt++; else { pushRun(cnt, last); last = v; cnt = 1; }
            }
            return new Uint8Array(out);
        }

        function nearestColorID(r, g, b, a) {
            if (a < 128) return 0;
            let best = 0, min = 1e9;
            for (const p of PALETTE) {
                const d = (r - p.rgb[0]) ** 2 + (g - p.rgb[1]) ** 2 + (b - p.rgb[2]) ** 2;
                if (d < min) { min = d; best = p.id; }
            }
            return best;
        }

        // --- 4. „É°„Ç§„É≥UI (App) ---
        function App() {
            const [lang, setLang] = useState('ja');
            const [theme, setTheme] = useState('dark');
            const [showHowTo, setShowHowTo] = useState(false);
            const [previewMode, setPreviewMode] = useState('original');
            const t = i18n[lang];

            const [imgFile, setImgFile] = useState(null);
            const [imgSrc, setImgSrc] = useState(null);
            const [height, setHeight] = useState(32);
            const [axis, setAxis] = useState('Z');
            const [isProcessing, setIsProcessing] = useState(false);
            const [status, setStatus] = useState(t.statusWait);

            const canvasRef = useRef(null);

            useEffect(() => {
                if (!imgFile) setStatus(t.statusWait);
                else if (status !== t.statusDone && !isProcessing) setStatus(t.statusLoaded);
            }, [lang]);

            const handleFileChange = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    setImgFile(file);
                    setImgSrc(URL.createObjectURL(file));
                    setStatus(t.statusLoaded);
                }
            };

            useEffect(() => {
                if (!imgSrc || !canvasRef.current) return;
                const img = new Image();
                img.src = imgSrc;
                img.onload = () => {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    const aspect = img.width / img.height;
                    const targetWidth = Math.round(height * aspect);
                    canvas.width = targetWidth; canvas.height = height;
                    ctx.imageSmoothingEnabled = false;
                    ctx.drawImage(img, 0, 0, targetWidth, height);

                    if (previewMode === 'bloxd') {
                        const imageData = ctx.getImageData(0, 0, targetWidth, height);
                        const data = imageData.data;
                        for (let i = 0; i < data.length; i += 4) {
                            const id = nearestColorID(data[i], data[i+1], data[i+2], data[i+3]);
                            const color = id === 0 ? [0,0,0,0] : PALETTE.find(p => p.id === id).rgb;
                            data[i] = color[0]; data[i+1] = color[1]; data[i+2] = color[2]; data[i+3] = id === 0 ? 0 : 255;
                        }
                        ctx.putImageData(imageData, 0, 0);
                    }
                };
            }, [imgSrc, height, previewMode]);

            const handleConvert = async () => {
                if (!imgSrc || !canvasRef.current || !imgFile) return;
                setIsProcessing(true); setStatus(t.statusConverting);
                try {
                    await new Promise(r => setTimeout(r, 50));
                    const img = new Image(); img.src = imgSrc;
                    await new Promise(r => img.onload = r);
                    const aspect = img.width / img.height;
                    const w = Math.round(height * aspect);
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = w; tempCanvas.height = height;
                    const ctx = tempCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, height);
                    const imgData = ctx.getImageData(0, 0, w, height).data;

                    const sizeY = height; const depth = 2;
                    let sizeX = axis === 'Z' ? w : depth;
                    let sizeZ = axis === 'Z' ? depth : w;
                    const blocks = Array.from({ length: sizeY }, () => Array.from({ length: sizeZ }, () => new Array(sizeX).fill(0)));
                    for (let y = 0; y < height; y++) {
                        for (let x = 0; x < w; x++) {
                            const i = (y * w + x) * 4;
                            const id = nearestColorID(imgData[i], imgData[i+1], imgData[i+2], imgData[i+3]);
                            if (!id) continue;
                            const by = sizeY - 1 - y;
                            if (axis === 'Z') { blocks[by][0][x] = id; blocks[by][1][x] = id; }
                            else { blocks[by][x][0] = id; blocks[by][x][1] = id; }
                        }
                    }

                    const writer = new BloxdWriter();
                    writer.u8(4); writer.u8(0); writer.u8(0); writer.u8(0);
                    writer.str("FromImage");
                    writer.zigzag(0); writer.zigzag(0); writer.zigzag(0);
                    writer.zigzag(sizeX); writer.zigzag(sizeY); writer.zigzag(sizeZ);
                    const CX = Math.ceil(sizeX/32), CY = Math.ceil(sizeY/32), CZ = Math.ceil(sizeZ/32);
                    writer.zigzag(CX*CY*CZ);
                    for(let cx=0; cx<CX; cx++) for(let cy=0; cy<CY; cy++) for(let cz=0; cz<CZ; cz++){
                        writer.zigzag(cx); writer.zigzag(cy); writer.zigzag(cz);
                        const raw = [];
                        for(let lx=0; lx<32; lx++) for(let ly=0; ly<32; ly++) for(let lz=0; lz<32; lz++){
                            const gx=cx*32+lx, gy=cy*32+ly, gz=cz*32+lz;
                            raw.push((gx<sizeX && gy<sizeY && gz<sizeZ) ? blocks[gy][gz][gx] : 0);
                        }
                        writer.bytes(compressRLE(raw));
                    }
                    writer.zigzag(0); writer.zigzag(0); writer.zigzag(0); writer.zigzag(0); writer.zigzag(0); writer.u8(0); writer.u8(0);

                    const downloadName = `image_${imgFile.name}_${height}x${w}.bloxdschem`;
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(writer.getBlob()); a.download = downloadName;
                    a.click();
                    setStatus(t.statusDone);
                } catch (e) { setStatus(`Error: ${e.message}`); }
                finally { setIsProcessing(false); }
            };

            return (
                <div className={`${theme} min-h-screen flex items-center justify-center p-4 transition-theme ${theme==='dark'?'bg-[#0f172a] text-slate-100':'bg-slate-50 text-slate-900'}`}>
                    <div className="fixed top-6 left-6 flex gap-3 z-40">
                        <button onClick={() => setShowHowTo(true)} className="glass w-12 h-12 rounded-xl flex items-center justify-center font-bold hover:scale-110 transition-transform">?</button>
                    </div>
                    <div className="fixed top-6 right-6 flex gap-3 z-40">
                        <button onClick={() => setTheme(theme==='dark'?'light':'dark')} className="glass px-4 py-2 rounded-xl text-lg hover:scale-105 transition-all">{theme==='dark'?'‚òÄÔ∏è':'üåô'}</button>
                        <button onClick={() => setLang(lang==='ja'?'en':'ja')} className="glass px-4 py-2 rounded-xl font-bold text-sm hover:scale-105 transition-all">{t.langBtn}</button>
                    </div>

                    <div className={`glass w-full max-w-3xl p-6 md:p-10 rounded-[2rem] shadow-2xl transition-all ${theme==='dark'?'bg-white/5':'bg-black/5'}`}>
                        <h1 className="text-3xl md:text-4xl font-cyber font-bold mb-2 text-center bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent italic">
                            {t.title}
                        </h1>
                        <div className="mb-8 text-center text-[10px] tracking-widest uppercase opacity-50 font-cyber">
                            {t.creator}: AIXAI_YT | <a href="https://www.youtube.com/@AIXAI-r7w" className="hover:text-green-400 underline">YouTube</a>
                        </div>

                        <div className="grid md:grid-cols-2 gap-8">
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-xs font-cyber mb-2 opacity-70">{t.labelFile}</label>
                                    <input type="file" accept="image/*" onChange={handleFileChange} className={`w-full text-xs p-3 rounded-xl border ${theme==='dark'?'border-white/10 bg-white/5':'border-black/10 bg-black/5'} cursor-pointer`} />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-cyber mb-2 opacity-70">{t.labelHeight}</label>
                                        <input type="number" value={height} onChange={e => setHeight(Number(e.target.value))} className={`w-full p-3 rounded-xl border font-cyber ${theme==='dark'?'border-white/10 bg-white/5':'border-black/10 bg-black/5'}`} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-cyber mb-2 opacity-70">{t.labelAxis}</label>
                                        <select value={axis} onChange={e => setAxis(e.target.value)} className={`w-full p-3 rounded-xl border font-cyber ${theme==='dark'?'border-white/10 bg-white/5':'border-black/10 bg-black/5'}`}>
                                            <option value="Z">{t.axisZ}</option>
                                            <option value="X">{t.axisX}</option>
                                        </select>
                                    </div>
                                </div>
                                <div className={`p-4 rounded-2xl text-center font-mono text-xs border ${theme==='dark'?'bg-black/40 border-green-500/30 text-green-400':'bg-white/40 border-green-600/30 text-green-700'} glow-green`}>
                                    {status}
                                </div>
                                <button onClick={handleConvert} disabled={!imgFile || isProcessing} className="w-full py-5 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-2xl font-cyber font-bold text-lg hover:shadow-lg transition-all active:scale-95 disabled:opacity-30">
                                    {isProcessing ? t.btnProcessing : t.btnConvert}
                                </button>
                            </div>

                            <div className="flex flex-col">
                                <label className="block text-xs font-cyber mb-2 opacity-70">{t.previewTitle}</label>
                                <div className={`flex-1 rounded-3xl overflow-hidden border ${theme==='dark'?'bg-black/40 border-white/10':'bg-slate-200 border-black/10'} min-h-[250px] flex flex-col`}>
                                    <div className="flex text-[10px] font-cyber border-b border-white/10">
                                        <button onClick={()=>setPreviewMode('original')} className={`flex-1 py-2 ${previewMode==='original'?'bg-white/10 text-green-400':''}`}>{t.prevOriginal}</button>
                                        <button onClick={()=>setPreviewMode('bloxd')} className={`flex-1 py-2 ${previewMode==='bloxd'?'bg-white/10 text-green-400':''}`}>{t.prevBloxd}</button>
                                    </div>
                                    <div className="flex-1 flex items-center justify-center p-4">
                                        {imgSrc ? <canvas ref={canvasRef} /> : <div className="text-[10px] opacity-20 font-cyber">NO IMAGE</div>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showHowTo && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={() => setShowHowTo(false)}>
                            <div className={`glass p-8 rounded-[2.5rem] max-w-md w-full shadow-2xl transition-all ${theme==='dark'?'bg-slate-900':'bg-white'}`} onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-cyber font-bold text-green-500 mb-6 text-center underline">{t.howToTitle}</h2>
                                <div className="space-y-4 text-sm opacity-90 leading-relaxed">
                                    <p>{t.howToStep1}</p><p>{t.howToStep2}</p><p>{t.howToStep3}</p><p>{t.howToStep4}</p>
                                    <div className="p-4 rounded-xl bg-black/20 border border-green-500/30 text-green-400 font-mono text-xs">
                                        {t.howToStep5}
                                    </div>
                                </div>
                                <button onClick={() => setShowHowTo(false)} className="mt-8 w-full py-3 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-600">
                                    {t.close}
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
